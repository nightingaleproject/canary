name: Deploy to CDC Azure

on:
  push:
    branches: [azure]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  id-token: write
  contents: read

jobs:
  deploy-aca:
      runs-on: ubuntu-latest
      # needs: image-builder
      environment: production
      steps:
      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Deploy container
        uses: azure/container-apps-deploy-action@v2
        with:
          registryUrl: ${{ env.REGISTRY }}
          imageToDeploy: ${{ env.IMAGE_NAME }}:sha256-a106350805c4d616a7b454b7836779be288134e578b75cf5ba2d58b77f4b46dc
          containerAppName: canary-v4
          resourceGroup: nchs-nvss-prd-moderate-canary-rg
          containerAppEnvironment: nvss-canary-prd-internal-container-app-env
          disableTelemetry: true
  # deploy:
  #   runs-on: ubuntu-latest
  #   steps:
  #   steps:
  #     - name: Log in to Azure
  #       uses: azure/login@v1
  #       with:
  #         creds: ${{ secrets.AZURE_CREDENTIALS }}
  #     - name: Build and push LATEST container image
  #       if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.deploy_level == 'latest') }}
  #       uses: azure/container-apps-deploy-action@v1
  #       with:
  #         appSourcePath: ${{ github.workspace }}
  #         registryUrl: ctenvss20221223092705.azurecr.io
  #         registryUsername: ${{ secrets.CTENVSSCANARY_REGISTRY_USERNAME }}
  #         registryPassword: ${{ secrets.CTENVSSCANARY_REGISTRY_PASSWORD }}
  #         containerAppName: nvss-canary-staging
  #         resourceGroup: CTE_NVSS
  #         imageToBuild: ctenvss20221223092705.azurecr.io/nvss-canary-staging:${{ github.sha }}
  #     - name: Build and push RELEASE container image
  #       if: ${{ github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.deploy_level == 'release') }}
  #       uses: azure/container-apps-deploy-action@v1
  #       with:
  #         appSourcePath: ${{ github.workspace }}
  #         registryUrl: ctenvss20221223092705.azurecr.io
  #         registryUsername: ${{ secrets.CTENVSSCANARY_REGISTRY_USERNAME }}
  #         registryPassword: ${{ secrets.CTENVSSCANARY_REGISTRY_PASSWORD }}
  #         containerAppName: nvss-canary
  #         resourceGroup: CTE_NVSS
  #         imageToBuild: ctenvss20221223092705.azurecr.io/nvss-canary:${{ github.sha }}
  #         permissions:
